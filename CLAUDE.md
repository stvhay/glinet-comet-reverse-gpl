# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Purpose

This project documents the reverse engineering of the GL.iNet Comet (RM1) KVM device to identify GPL-licensed components and facilitate GPL compliance requests to GL.iNet. The goal is to create reproducible scripts and documentation that others can use to analyze the publicly available firmware.

**Repository**: https://github.com/stvhay/glinet-comet-reverse-gpl

## Legal Constraints

**IMPORTANT**: This repository must only contain:
- Scripts to download publicly available firmware
- Analysis scripts and tools
- Documentation of methodology
- References to GPL-licensed source code

**DO NOT commit**:
- Binary firmware files (*.bin, *.img)
- Extracted filesystem contents
- Any proprietary code or data
- Analysis results (these are generated by CI)

All analysis should be reproducible from the publicly available firmware download.

## Firmware Source

- **URL**: https://fw.gl-inet.com/kvm/rm1/release/glkvm-RM1-1.7.2-1128-1764344791.img
- **Format**: Rockchip RKFW firmware image
- **Device**: GL.iNet Comet (RM1) KVM

## Useful Tools

- `binwalk` - Firmware analysis and extraction
- `unsquashfs` - SquashFS extraction (from squashfs-tools)
- `dtc` - Device Tree compiler/decompiler
- `strings`, `xxd` - Binary analysis

---

## Development Standards

### Always Use Nix Environment

ALL commands must run inside `nix develop` or via direnv.

```bash
# Enter development environment
nix develop

# Or with direnv
direnv allow

# Run analysis locally
./scripts/analyze.sh
```

### Git Commit Standards

**Atomic Commits**: One logical change = one commit
- Good: `feat: Add kernel module extraction to analyze script`
- Good: `fix: Handle missing squashfs in firmware`
- Bad: `Update script, fix paths, add new analysis`

**Commit message format:**
```
<type>: <description>

<optional body explaining why, not what>

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
```

**Types:**
- `feat:` - New analysis capability or script
- `fix:` - Bug fix
- `docs:` - Documentation updates
- `refactor:` - Code restructuring without behavior change
- `chore:` - Build process, dependencies, tooling

**Use HEREDOC for multi-line messages:**
```bash
git commit -m "$(cat <<'EOF'
<message here>
EOF
)"
```

**Never push without explicit user permission**

### Code Quality

**Bash scripts** 
- Follow https://mywiki.wooledge.org/FullBashGuide
- Quote variables
- Use `shellcheck`

**Python** (if used)
- Follow PEP 8
- Use type hints for public functions
- Docstrings for public functions/classes

**General principles:**
- Write clearly - self-documenting code preferred
- Comment the why, not the what
- Single responsibility per function
- Test scripts before committing

### When to Comment
- Complex extraction logic
- Workarounds for tool limitations
- Security/legal considerations

### Working with Claude

**Always do:**
- Read files before editing
- Run scripts after changes
- Atomic commits with type prefix
- Ask before pushing
- Use nix develop for all commands

**Never do:**
- Push without permission
- Bundle unrelated changes
- Use commands outside nix environment
- Commit binary files or extracted content
- Commit analysis results (CI generates these)
- Skip testing before committing

## CI/CD

- GitHub Actions runs on push to `main` and PRs
- Tagged releases (`v*`) automatically create GitHub releases with analysis output
- Analysis results are uploaded as artifacts (not committed to repo)
